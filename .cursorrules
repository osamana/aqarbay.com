# AqarBay Project - Development & Production Management Rules

## Project Overview
- **Name**: AqarBay Palestine Real Estate Platform
- **Stack**: Next.js 14 (Frontend) + FastAPI (Backend)
- **Infrastructure**: Docker Compose, PostgreSQL, Redis, MinIO, Meilisearch
- **Production**: Dokploy on server 72.60.191.38
- **Domain**: aqarbay.com

---

## Environment Contexts

### LOCAL DEVELOPMENT
- **Purpose**: Development, testing, and debugging on local machine
- **URL**: http://localhost:3000 (web), http://localhost:8000 (api)
- **Database**: Local PostgreSQL in Docker
- **Files**: `.env` (local), `docker-compose.dev.yml` (if exists)
- **Git Branch**: Usually `develop` or feature branches

### PRODUCTION (Dokploy)
- **Purpose**: Live deployment for end users
- **Server**: 72.60.191.38 (SSH: root@72.60.191.38)
- **URL**: https://aqarbay.com (web), https://api.aqarbay.com (api)
- **Domain URLs**:
  - Main: https://aqarbay.com
  - API: https://api.aqarbay.com
  - S3: https://s3.aqarbay.com
  - MinIO Admin: https://admin.s3.aqarbay.com
- **Files**: Environment variables in Dokploy UI
- **Git Branch**: `main` (auto-deploys via Dokploy)
- **Deployment**: Git push ‚Üí Dokploy auto-builds ‚Üí Containers restart

---

## Smart Development Rules

### 1. Always Ask Context First
When the user requests changes, ALWAYS ask or determine:
- "Is this for **local development** or **production**?"
- If unclear, default to **local development** and mention it

### 2. File Changes Based on Context

#### For LOCAL Development:
- ‚úÖ Edit code files directly
- ‚úÖ Use `docker-compose up -d` for local services
- ‚úÖ Make experimental changes
- ‚úÖ Use hot-reload (volumes mounted)
- ‚úÖ Run migrations locally
- ‚ùå DON'T commit `.env` files
- ‚ùå DON'T push directly to `main` branch

#### For PRODUCTION:
- ‚úÖ Make changes in code
- ‚úÖ Test locally FIRST
- ‚úÖ Commit to git with clear messages
- ‚úÖ Push to `main` branch
- ‚úÖ Verify Dokploy auto-deploys
- ‚úÖ Check logs via SSH if needed
- ‚ùå DON'T make direct changes on server
- ‚ùå DON'T manually edit files on server
- ‚ùå DON'T restart services manually (let Dokploy handle it)

### 3. Docker Compose Differences

#### LOCAL (`docker-compose.yml` - development mode):
```yaml
# API service should have:
volumes:
  - ./apps/api:/app  # Hot-reload
command: uvicorn app.main:app --reload  # Auto-reload on changes

# Web service should have:
volumes:
  - ./apps/web:/app
  - /app/node_modules
  - /app/.next
# Run: docker-compose up -d
```

#### PRODUCTION (same file, but Dokploy uses without volumes):
```yaml
# API service - NO volumes (baked into image)
# Web service - NO volumes (baked into image)
# Dokploy handles: docker-compose -f docker-compose.yml up -d --build
```

**Current Setup**: Production mode (no volumes) is the default in docker-compose.yml

### 4. Environment Variables

#### LOCAL (.env file):
```bash
# Use simple values for local testing
POSTGRES_PASSWORD=localtest123
JWT_SECRET=local-dev-secret-not-secure
MINIO_ROOT_PASSWORD=localtest123
# URLs point to localhost
NEXT_PUBLIC_API_URL=http://localhost:8000
```

#### PRODUCTION (Dokploy UI):
```bash
# Use secure generated secrets
POSTGRES_PASSWORD=<64-char-secure-password>
JWT_SECRET=<64-char-hex-secret>
# URLs point to production domains
NEXT_PUBLIC_API_URL=https://api.aqarbay.com
```

**Current Production Secrets** (stored in Dokploy):
- POSTGRES_PASSWORD: `K8mNp2vR9xQwE5tY7uH3jL6nB4zX1cV8`
- JWT_SECRET: `a7f3e9d2c8b6f1a4e7d9c3b8f2a6e1d4c9b7f3a8e2d6c1b9f4a7e3d8c2b6f1a5`
- MINIO_ROOT_PASSWORD: `T9pL4xW2vN8mQ3rY6hJ1zK5bC7sF0gD9`
- MEILI_MASTER_KEY: `b6e4f8d1c9a7e3b2f5d8c4a1e7b3f9d2c8a6e4b1f7d3c9a5e2b8f4d1c6a3e9b7`
- ADMIN_PASSWORD: `AqarBay2026!Admin#Secure`

### 5. Common Workflows

#### Starting Local Development:
```bash
# 1. Ensure .env exists
cp .env.example .env

# 2. Start all services
docker-compose up -d

# 3. Wait for services to be healthy
sleep 30

# 4. Run migrations (first time)
docker-compose exec api alembic upgrade head

# 5. Create admin user (first time)
docker-compose exec api python -m app.scripts.create_admin

# 6. View logs
docker-compose logs -f api web
```

#### Making Changes Locally:
```bash
# 1. Create feature branch
git checkout -b feature/your-feature

# 2. Make code changes
# Edit files...

# 3. Test locally
docker-compose restart api  # If API changes
docker-compose restart web  # If web changes

# 4. View logs
docker-compose logs -f api

# 5. Commit when working
git add .
git commit -m "feat: description"
```

#### Deploying to Production:
```bash
# 1. Ensure changes tested locally
docker-compose up -d
# Test thoroughly...

# 2. Merge to main branch
git checkout main
git merge feature/your-feature

# 3. Push to trigger Dokploy deployment
git push origin main

# 4. Monitor deployment in Dokploy UI
# Or check logs via SSH:
ssh root@72.60.191.38 "docker logs aqarbay-api --tail 50"

# 5. Verify production
curl https://api.aqarbay.com/health
curl https://aqarbay.com
```

#### Emergency Production Debug:
```bash
# SSH into production server
ssh root@72.60.191.38

# Check container status
docker ps -a | grep aqarbay

# View logs
docker logs aqarbay-api --tail 100
docker logs aqarbay-web --tail 100

# Check health
docker exec aqarbay-api python -c "import urllib.request; print(urllib.request.urlopen('http://localhost:8000/health').read())"

# Restart if needed (last resort)
cd /etc/dokploy/compose/xario-aqarbay-i5ttcs/code
docker-compose restart api
docker-compose restart web
```

### 6. Database Migrations

#### LOCAL:
```bash
# Create new migration
docker-compose exec api alembic revision --autogenerate -m "description"

# Apply migrations
docker-compose exec api alembic upgrade head

# Rollback if needed
docker-compose exec api alembic downgrade -1
```

#### PRODUCTION:
```bash
# After pushing migration files to main branch:
ssh root@72.60.191.38
cd /etc/dokploy/compose/xario-aqarbay-i5ttcs/code
docker-compose exec api alembic upgrade head

# Or via Dokploy terminal (select api container):
alembic upgrade head
```

### 7. Testing Before Production

#### Always Test These Locally Before Pushing:
```bash
# 1. Build fresh images
docker-compose down
docker-compose build --no-cache
docker-compose up -d

# 2. Wait for health checks
sleep 40
docker-compose ps  # All should be "healthy"

# 3. Test API endpoints
curl http://localhost:8000/health
curl http://localhost:8000/api/public/properties

# 4. Test Web
curl http://localhost:3000
# Open in browser: http://localhost:3000

# 5. Test admin login
# http://localhost:3000/en/admin/login

# 6. Create test property with image upload

# 7. If all works, safe to deploy!
```

---

## AI Assistant Behavior Rules

### When User Says "fix this error":
1. ‚úÖ Ask: "Is this error happening **locally** or in **production**?"
2. ‚úÖ If local: Edit files, test with `docker-compose restart`
3. ‚úÖ If production: Edit files, tell user to push, remind to check Dokploy logs

### When User Says "add feature X":
1. ‚úÖ Implement in code
2. ‚úÖ Test locally first
3. ‚úÖ Provide git commands to deploy
4. ‚úÖ Remind about production testing

### When User Says "it's not working":
1. ‚úÖ Ask: "Local or production?"
2. ‚úÖ If local: Check `docker-compose logs`
3. ‚úÖ If production: SSH and check logs, or ask user to check Dokploy
4. ‚úÖ Never guess - always verify logs

### When User Requests Database Changes:
1. ‚úÖ Create migration file
2. ‚úÖ Test locally first
3. ‚úÖ Remind: "After pushing, run migration on production via SSH"
4. ‚úÖ Provide exact commands for both environments

### When Making Docker Changes:
1. ‚úÖ Update docker-compose.yml
2. ‚úÖ Test with `docker-compose up -d --build`
3. ‚úÖ Remind: "Push to main to deploy to production"
4. ‚úÖ Note: Dokploy will rebuild automatically

### Security Reminders:
- ‚ùå NEVER commit `.env` files
- ‚ùå NEVER put secrets in code
- ‚ùå NEVER share production passwords in chat
- ‚úÖ Always use environment variables
- ‚úÖ Keep .env.example updated (without real secrets)

---

## Quick Reference Commands

### Local Development:
```bash
# Start everything
docker-compose up -d

# Stop everything
docker-compose down

# Rebuild and restart
docker-compose up -d --build

# View logs
docker-compose logs -f [service]

# Execute commands
docker-compose exec api [command]
docker-compose exec web [command]

# Reset everything (CAREFUL!)
docker-compose down -v  # Deletes data!
```

### Production (via SSH):
```bash
# SSH in
ssh root@72.60.191.38

# Check status
docker ps -a | grep aqarbay

# View logs
docker logs aqarbay-api --tail 100
docker logs aqarbay-web --tail 100

# Run commands
docker exec aqarbay-api alembic upgrade head
docker exec aqarbay-api python -m app.scripts.create_admin

# Restart (if needed)
docker restart aqarbay-api
docker restart aqarbay-web
```

### Git Workflow:
```bash
# Create feature branch
git checkout -b feature/name

# Work and commit
git add .
git commit -m "feat: description"

# Deploy to production
git checkout main
git merge feature/name
git push origin main  # Triggers Dokploy deployment

# Check deployment
# Monitor in Dokploy UI
```

---

## File Structure Awareness

```
aqarbay/
‚îú‚îÄ‚îÄ .env                          # LOCAL ONLY - DO NOT COMMIT
‚îú‚îÄ‚îÄ .env.example                  # Template - SAFE TO COMMIT
‚îú‚îÄ‚îÄ docker-compose.yml            # Production config
‚îú‚îÄ‚îÄ docker-compose.dev.yml        # Local dev config (if needed)
‚îú‚îÄ‚îÄ apps/
‚îÇ   ‚îú‚îÄ‚îÄ api/                      # FastAPI backend
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ app/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Dockerfile            # Production image
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ requirements.txt
‚îÇ   ‚îî‚îÄ‚îÄ web/                      # Next.js frontend
‚îÇ       ‚îú‚îÄ‚îÄ app/
‚îÇ       ‚îú‚îÄ‚îÄ Dockerfile            # Production image
‚îÇ       ‚îî‚îÄ‚îÄ package.json
‚îú‚îÄ‚îÄ QUICK_DEPLOY_GUIDE.md        # Production deployment
‚îú‚îÄ‚îÄ DOKPLOY_DEPLOYMENT.md        # Detailed prod guide
‚îî‚îÄ‚îÄ README.md                     # Project overview
```

---

## Health Check Knowledge

### API Health Check (Fixed):
```yaml
# Uses Python (available in container)
test: ["CMD-SHELL", "python -c \"import urllib.request; urllib.request.urlopen('http://localhost:8000/health')\" || exit 1"]
```

### Web Health Check (Fixed):
```yaml
# Uses wget with IPv4 (127.0.0.1)
test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://127.0.0.1:3000 || exit 1"]
```

### Meilisearch Health Check (Fixed):
```yaml
# Uses curl with IPv4
test: ["CMD-SHELL", "curl -f http://127.0.0.1:7700/health || exit 1"]
```

**Why Fixed**: Original health checks used tools not available in slim images or had IPv6 issues.

---

## Troubleshooting Decision Tree

### Service Won't Start:
1. Check logs: `docker-compose logs [service]`
2. Check health: `docker-compose ps`
3. Check env vars: Are all required vars set?
4. Check dependencies: Are dependent services healthy?

### Code Changes Not Reflected:
**Local**: Did you restart? `docker-compose restart [service]`
**Production**: Did you push? Check Dokploy deployment logs

### Database Issues:
**Local**: `docker-compose exec api alembic upgrade head`
**Production**: SSH in and run migrations

### Domain Not Working:
1. Check DNS: `dig aqarbay.com`
2. Check Dokploy domain config
3. Check SSL certificate status
4. Check container is running: `docker ps | grep aqarbay-web`

---

## Remember:
- üè† **Local** = Fast iteration, experimentation, hot-reload
- üåê **Production** = Tested code, git-based deployment, monitoring
- üîÑ **Workflow** = Develop locally ‚Üí Test locally ‚Üí Push to main ‚Üí Auto-deploy
- üö® **Never** = Edit files directly on production server
- ‚úÖ **Always** = Test locally before deploying to production

---

**This rule helps the AI assistant provide context-aware guidance for AqarBay development and deployment.**

